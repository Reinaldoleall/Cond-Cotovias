<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Sistema de Encomendas</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/introjs.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1565c0;
            --primary-dark: #0d47a1;
            --primary-light: #5e92f3;
            --secondary-color: #26a69a;
            --accent-color: #ffab00;
            --error-color: #f44336;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --text-color: #333;
            --light-text: #757575;
            --lighter-text: #bdbdbd;
            --background: #f5f5f5;
            --card-background: #ffffff;
            --border-color: #e0e0e0;
        }
        
        h1, h2, h3, h4, h5, h6 {
  font-weight: 500;
  margin-bottom: 1rem;
  color: var(--primary-dark);
}

p {
  margin-bottom: 1rem;
}

    /* Card de login */
    .card {
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.9);
    }

a {
  color: var(--primary-color);
  text-decoration: none;
  transition: color 0.3s;
}

        /* Estilos de validação melhorados */
        .input-field .helper-text {
            color: var(--light-text);
            font-size: 0.8rem;
        }

        .input-field .success-message {
            color: var(--success-color);
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: none;
        }

        .input-field .error-message {
            color: var(--error-color);
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: none;
        }

        .input-field.invalid .error-message {
            display: block;
        }

        .input-field.valid .success-message {
            display: block;
        }

        .input-field.invalid input,
        .input-field.invalid textarea,
        .input-field.invalid select {
            border-bottom-color: var(--error-color) !important;
            box-shadow: 0 1px 0 0 var(--error-color) !important;
        }

        .input-field.valid input,
        .input-field.valid textarea,
        .input-field.valid select {
            border-bottom-color: var(--success-color) !important;
            box-shadow: 0 1px 0 0 var(--success-color) !important;
        }

        /* Toast personalizado */
        .toast {
            border-radius: 4px;
            padding: 16px;
            color: white;
            font-weight: 500;
        }

        .toast.success {
            background-color: var(--success-color);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        .toast.warning {
            background-color: var(--warning-color);
        }

        .toast.info {
            background-color: var(--primary-color);
        }


        .help-button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
        }

        /* Mensagem de status */
        .status-message {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
            display: none;
        }

        .status-message.success {
            background-color: #e8f5e9;
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
            display: block;
        }

        .status-message.error {
            background-color: #ffebee;
            color: var(--error-color);
            border-left: 4px solid var(--error-color);
            display: block;
        }
    </style>
</head>
<body>

    <!-- Botão de ajuda flutuante -->

    <div class="container">
        <div class="section">
            <div class="row">
                <div class="col s12 m8 offset-m2">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title center-align"><h4>Cadastro</h4></span>
                            
                            <!-- Mensagem de status -->
                            <div id="statusMessage" class="status-message"></div>
                            
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">person</i>
                                    <input id="nome" type="text" class="validate" required>
                                    <label for="nome">Nome Completo *</label>
                                    <span class="helper-text">Informe seu nome completo</span>
                                    <span class="error-message" id="nome-error">Por favor, informe seu nome completo</span>
                                    <span class="success-message">Nome válido</span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">email</i>
                                    <input id="emailCadastro" type="email" class="validate" required>
                                    <label for="emailCadastro">Email *</label>
                                    <span class="helper-text">Informe um email válido</span>
                                    <span class="error-message" id="email-error">Por favor, informe um email válido</span>
                                    <span class="success-message">Email válido</span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">lock</i>
                                    <input id="senhaCadastro" type="password" class="validate" required>
                                    <label for="senhaCadastro">Senha *</label>
                                    <span class="helper-text">Mínimo 6 caracteres</span>
                                    <span class="error-message" id="senha-error">A senha deve ter pelo menos 6 caracteres</span>
                                    <span class="success-message">Senha válida</span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">lock</i>
                                    <input id="confirmarSenha" type="password" class="validate" required>
                                    <label for="confirmarSenha">Confirmar Senha *</label>
                                    <span class="helper-text">Digite a senha novamente</span>
                                    <span class="error-message" id="confirmar-senha-error">As senhas não coincidem</span>
                                    <span class="success-message">Senhas coincidem</span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col s12">
                                    <p><strong>Tipo de Cadastro: *</strong></p>
                                    <label>
                                        <input name="tipoUsuario" type="radio" value="portaria" id="tipoPortaria" />
                                        <span>Portaria</span>
                                    </label>
                                    <label>
                                        <input name="tipoUsuario" type="radio" value="morador" id="tipoMorador" checked />
                                        <span>Morador</span>
                                    </label>
                                    <span class="error-message" id="tipo-usuario-error">Selecione um tipo de cadastro</span>
                                </div>
                            </div>
                            
                            <!-- Dados específicos para moradores -->
                            <div id="dadosMorador">
                                <div class="row">
                                    <div class="input-field col s6">
                                        <i class="material-icons prefix">home</i>
                                        <input id="bloco" type="text" class="validate" required>
<p>Atenção ao cadastro: sempre utilize 2 dígitos para o bloco (exemplo: 01).</p>
                                        <label for="bloco">Bloco 2 Digitos*</label>
                                        <span class="error-message" id="bloco-error">Informe o bloco</span>
                                        <span class="success-message">Bloco válido</span>
                                    </div>
                                    <div class="input-field col s6">
                                      
                                        <i class="material-icons prefix">meeting_room</i>
                                        <input id="apartamento" type="text" class="validate" required>
                                        <label for="apartamento">Apartamento 3 Digitos*</label>
                                        
                                        <p>Atenção ao cadastro: sempre utilize 3 dígitos para o apartamento (exemplo: 123).</p>
                                        <span class="error-message" id="apartamento-error">Informe o apartamento</span>
                                        <span class="success-message">Apartamento válido</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dados específicos para porteiros -->
                            <div id="dadosPorteiro">
                                <div class="row">
                                    <div class="input-field col s12">
                                        <i class="material-icons prefix">vpn_key</i>
                                        <input id="codigoPorteiro" type="password" class="validate" required>
                                        <label for="codigoPorteiro">Código de Acesso *</label>
                                        <span class="helper-text">Fornecido pela administração do condomínio</span>
                                        <span class="error-message" id="codigo-porteiro-error">Código de acesso inválido</span>
                                        <span class="success-message">Código válido</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col s12 center-align">
                                    <button id="btnCadastrar" class="btn waves-effect waves-light blue darken-3">
                                        <i class="material-icons left">person_add</i>
                                        Cadastrar
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col s12 center-align">
                                    Já tem uma conta? <a href="login.html">Faça login</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/6.0.0/intro.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
  apiKey: "AIzaSyByyM8RvGNM5pyrQIQ7nCH6mmgYAIpq0bc",
  authDomain: "rifas-c414b.firebaseapp.com",
  databaseURL: "https://rifas-c414b-default-rtdb.firebaseio.com",
  projectId: "rifas-c414b",
  storageBucket: "rifas-c414b.firebasestorage.app",
  messagingSenderId: "770195193538",
  appId: "1:770195193538:web:48e585ac5661d27f3dc55b"
};

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const nomeInput = document.getElementById('nome');
            const emailInput = document.getElementById('emailCadastro');
            const senhaInput = document.getElementById('senhaCadastro');
            const confirmarSenhaInput = document.getElementById('confirmarSenha');
            const tipoPortaria = document.getElementById('tipoPortaria');
            const tipoMorador = document.getElementById('tipoMorador');
            const blocoInput = document.getElementById('bloco');
            const apartamentoInput = document.getElementById('apartamento');
            const codigoPorteiroInput = document.getElementById('codigoPorteiro');
            const btnCadastrar = document.getElementById('btnCadastrar');
            const dadosMorador = document.getElementById('dadosMorador');
            const dadosPorteiro = document.getElementById('dadosPorteiro');
            const statusMessage = document.getElementById('statusMessage');

            // Mostra os campos de morador por padrão
            dadosMorador.style.display = 'block';
            dadosPorteiro.style.display = 'none';

            // Validação em tempo real
            nomeInput.addEventListener('blur', validarNome);
            emailInput.addEventListener('blur', validarEmail);
            senhaInput.addEventListener('input', validarSenha);
            confirmarSenhaInput.addEventListener('blur', validarConfirmarSenha);
            blocoInput.addEventListener('blur', validarBloco);
            apartamentoInput.addEventListener('blur', validarApartamento);
            codigoPorteiroInput.addEventListener('blur', validarCodigoPorteiro);

            // Alternar entre morador e porteiro
            tipoPortaria.addEventListener('change', function() {
                if (this.checked) {
                    dadosMorador.style.display = 'none';
                    dadosPorteiro.style.display = 'block';
                    // Limpa erros dos campos de morador
                    clearValidation(blocoInput);
                    clearValidation(apartamentoInput);
                }
            });

            tipoMorador.addEventListener('change', function() {
                if (this.checked) {
                    dadosMorador.style.display = 'block';
                    dadosPorteiro.style.display = 'none';
                    // Limpa erros dos campos de porteiro
                    clearValidation(codigoPorteiroInput);
                }
            });

            // Submissão do formulário
            btnCadastrar.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Validar todos os campos
                const isNomeValid = validarNome();
                const isEmailValid = validarEmail();
                const isSenhaValid = validarSenha();
                const isConfirmarSenhaValid = validarConfirmarSenha();
                
                let isTipoUsuarioValid = true;
                if (!tipoMorador.checked && !tipoPortaria.checked) {
                    showError('tipo-usuario-error', 'Selecione um tipo de usuário');
                    isTipoUsuarioValid = false;
                } else {
                    clearError('tipo-usuario-error');
                }
                
                let isDadosEspecificosValid = true;
                if (tipoMorador.checked) {
                    const isBlocoValid = validarBloco();
                    const isApartamentoValid = validarApartamento();
                    isDadosEspecificosValid = isBlocoValid && isApartamentoValid;
                } else if (tipoPortaria.checked) {
                    const isCodigoValid = validarCodigoPorteiro();
                    isDadosEspecificosValid = isCodigoValid;
                }
                
                // Se todos os campos forem válidos, prosseguir com o cadastro
                if (isNomeValid && isEmailValid && isSenhaValid && isConfirmarSenhaValid && 
                    isTipoUsuarioValid && isDadosEspecificosValid) {
                    
                    cadastrarUsuario();
                } else {
                    showStatusMessage('Por favor, corrija os erros no formulário', 'error');
                }
            });

            // Funções de validação
            function validarNome() {
                const nome = nomeInput.value.trim();
                if (!nome) {
                    setInvalid(nomeInput, 'Por favor, informe seu nome completo');
                    return false;
                } else if (nome.length < 3) {
                    setInvalid(nomeInput, 'O nome deve ter pelo menos 3 caracteres');
                    return false;
                } else {
                    setValid(nomeInput);
                    return true;
                }
            }
            
            function validarEmail() {
                const email = emailInput.value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!email) {
                    setInvalid(emailInput, 'Por favor, informe seu e-mail');
                    return false;
                } else if (!emailRegex.test(email)) {
                    setInvalid(emailInput, 'Por favor, insira um e-mail válido');
                    return false;
                } else {
                    setValid(emailInput);
                    return true;
                }
            }
            
            function validarSenha() {
                const senha = senhaInput.value;
                
                if (!senha) {
                    setInvalid(senhaInput, 'Por favor, crie uma senha');
                    return false;
                } else if (senha.length < 6) {
                    setInvalid(senhaInput, 'A senha deve ter pelo menos 6 caracteres');
                    return false;
                } else {
                    setValid(senhaInput);
                    return true;
                }
            }
            
            function validarConfirmarSenha() {
                const senha = senhaInput.value;
                const confirmarSenha = confirmarSenhaInput.value;
                
                if (!confirmarSenha) {
                    setInvalid(confirmarSenhaInput, 'Por favor, confirme sua senha');
                    return false;
                } else if (senha !== confirmarSenha) {
                    setInvalid(confirmarSenhaInput, 'As senhas não coincidem');
                    return false;
                } else {
                    setValid(confirmarSenhaInput);
                    return true;
                }
            }
            
            function validarBloco() {
                const bloco = blocoInput.value.trim();
                if (!bloco) {
                    setInvalid(blocoInput, 'Por favor, informe o bloco');
                    return false;
                } else {
                    setValid(blocoInput);
                    return true;
                }
            }
            
            function validarApartamento() {
                const apartamento = apartamentoInput.value.trim();
                if (!apartamento) {
                    setInvalid(apartamentoInput, 'Por favor, informe o apartamento');
                    return false;
                } else {
                    setValid(apartamentoInput);
                    return true;
                }
            }
            
            function validarCodigoPorteiro() {
                const codigo = codigoPorteiroInput.value.trim();
                if (!codigo) {
                    setInvalid(codigoPorteiroInput, 'Por favor, informe o código de acesso');
                    return false;
                } else if (codigo !== "PORTARIA123") {
                    setInvalid(codigoPorteiroInput, 'Código de acesso inválido');
                    return false;
                } else {
                    setValid(codigoPorteiroInput);
                    return true;
                }
            }
            
            // Funções auxiliares de validação
            function setInvalid(inputElement, message) {
                const fieldId = inputElement.id;
                const errorElement = document.getElementById(`${fieldId}-error`);
                
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                    inputElement.parentElement.querySelector('.success-message').style.display = 'none';
                }
                
                inputElement.classList.add('invalid');
                inputElement.classList.remove('valid');
            }
            
            function setValid(inputElement) {
                const fieldId = inputElement.id;
                const errorElement = document.getElementById(`${fieldId}-error`);
                const successElement = inputElement.parentElement.querySelector('.success-message');
                
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                
                if (successElement) {
                    successElement.style.display = 'block';
                }
                
                inputElement.classList.add('valid');
                inputElement.classList.remove('invalid');
            }
            
            function clearValidation(inputElement) {
                const fieldId = inputElement.id;
                const errorElement = document.getElementById(`${fieldId}-error`);
                const successElement = inputElement.parentElement.querySelector('.success-message');
                
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                
                if (successElement) {
                    successElement.style.display = 'none';
                }
                
                inputElement.classList.remove('invalid');
                inputElement.classList.remove('valid');
            }
            
            function showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
            }
            
            function clearError(elementId) {
                const errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            }
            
            function showStatusMessage(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type}`;
                statusMessage.style.display = 'block';
                
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
            
            // Função para cadastrar usuário no Firebase
        function cadastrarUsuario() {
            const nome = nomeInput.value.trim();
            const email = emailInput.value.trim();
            const senha = senhaInput.value;
            const tipoUsuario = tipoMorador.checked ? 'morador' : 'portaria';
            const bloco = tipoMorador.checked ? blocoInput.value.trim() : null;
            const apartamento = tipoMorador.checked ? apartamentoInput.value.trim() : null;
            
            btnCadastrar.disabled = true;
            btnCadastrar.innerHTML = '<i class="material-icons left">hourglass_empty</i> Cadastrando...';
            
            // Criar usuário no Firebase Auth
            auth.createUserWithEmailAndPassword(email, senha)
                .then((userCredential) => {
                    // Salvar informações adicionais no Realtime Database
                    const userData = {
                        nome: nome,
                        email: email,
                        tipo: tipoUsuario,
                        dataCadastro: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    if (tipoUsuario === 'morador') {
                        userData.bloco = bloco;
                        userData.apartamento = apartamento;
                        userData.blocoApto = `${bloco}-${apartamento}`;
                    }
                    
                    return database.ref('users/' + userCredential.user.uid).set(userData);
                })
                .then(() => {
                    showToast('Cadastro realizado com sucesso!', 'success');
                    
                    // Redirecionar após 2 segundos - CORREÇÃO APLICADA AQUI
                    setTimeout(() => {
                        if (tipoUsuario === 'morador') {
                            window.location.href = 'usuario.html';
                        } else {
                            window.location.href = 'portaria.html'; // Corrigido para portaria.html
                        }
                    }, 2000);
                })
                .catch((error) => {
                    handleFirebaseError(error);
                    btnCadastrar.disabled = false;
                    btnCadastrar.innerHTML = '<i class="material-icons left">person_add</i> Cadastrar';
                });
        }
            
            // Manipulador de erros do Firebase
            function handleFirebaseError(error) {
                let errorMessage = 'Erro ao cadastrar';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este email já está em uso';
                        setInvalid(emailInput, errorMessage);
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inválido';
                        setInvalid(emailInput, errorMessage);
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Senha muito fraca (mínimo 6 caracteres)';
                        setInvalid(senhaInput, errorMessage);
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'Operação não permitida';
                        break;
                    default:
                        errorMessage = error.message || 'Erro desconhecido';
                }
                
                showToast(errorMessage, 'error');
                showStatusMessage(errorMessage, 'error');
            }
            
            // Mostrar toast notification
            function showToast(message, type) {
                M.toast({
                    html: message,
                    classes: type,
                    displayLength: 4000
                });
            }
        });
    </script>
</body>
</html>